# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Backend API REST construido con Symfony 7.3.4 y PHP 8.2+ que implementa un sistema CRUD con autenticación JWT. Utiliza PostgreSQL como base de datos y Doctrine ORM para el manejo de entidades.

## Technology Stack

- **Framework**: Symfony 7.3.4
- **PHP**: >= 8.2
- **Database**: PostgreSQL 16
- **ORM**: Doctrine ORM 3.5
- **Authentication**: Lexik JWT Authentication Bundle 3.1
- **Maker Bundle**: Symfony Maker Bundle (development)

## Essential Commands

### Running the Application
```bash
# Start Symfony development server
php -S localhost:8000 -t public/

# Or use Symfony CLI
symfony server:start
```

### Database & Migrations
```bash
# Run all pending migrations
php bin/console doctrine:migrations:migrate

# Generate a new migration from entity changes
php bin/console doctrine:migrations:diff

# Check migration status
php bin/console doctrine:migrations:status

# Execute raw SQL
php bin/console dbal:run-sql "SELECT * FROM cliente"
```

### Code Generation
```bash
# Create a new entity
php bin/console make:entity

# Create a new controller
php bin/console make:controller

# Generate CRUD operations for an entity
php bin/console make:crud

# Create a new migration manually
php bin/console make:migration
```

### Debugging & Development
```bash
# List all routes
php bin/console debug:router

# Show route details
php bin/console debug:router api_cliente_list

# List all services
php bin/console debug:container

# Clear cache
php bin/console cache:clear

# Check security configuration
php bin/console debug:firewall
```

## Architecture & Code Structure

### Directory Structure
```
src/
├── Controller/       # API endpoints
│   ├── ClienteController.php
│   └── UsuarioController.php
├── Entity/          # Doctrine entities (database models)
│   ├── Cliente.php
│   ├── Usuario.php
│   ├── Direccion.php
│   └── RefreshToken.php
├── Repository/      # Doctrine repositories
└── Kernel.php
```

### Authentication System

The API uses JWT authentication with refresh tokens:

1. **JWT Tokens**: Short-lived access tokens generated by Lexik JWT Bundle
2. **Refresh Tokens**: Long-lived tokens (30 days) stored in database for token renewal
3. **Security Firewalls**:
   - `/api/auth/*` - Public access (login, refresh)
   - `/api/*` - Requires JWT authentication (IS_AUTHENTICATED_FULLY)

**IMPORTANT**: Passwords in the Usuario entity are stored as plain text (field `clave`), not hashed. This is a security concern for production environments.

### API Endpoints

#### Authentication (`/api/auth`)
- `POST /api/auth/login` - Login with username and password
  - Request: `{ "nombreUsuario": "string", "clave": "string" }`
  - Response: `{ "token": "jwt_token", "refresh_token": "refresh_token" }`

- `POST /api/auth/refresh` - Refresh expired JWT token
  - Request: `{ "refresh_token": "token" }`
  - Response: `{ "token": "new_jwt", "refresh_token": "new_refresh_token" }`

#### User (`/api/usuario`)
- `GET /api/usuario/perfil` - Get authenticated user profile (requires JWT)
- `GET /api/usuario/{id}/avatar` - Get user avatar URL

#### Cliente CRUD (`/api/cliente`)
- `GET /api/cliente` - List all clients
- `POST /api/cliente` - Create new client (nombre required)
- `PATCH /api/cliente/{id}` - Update client (partial update)
- `DELETE /api/cliente/{id}` - Delete client

### Entities & Database Schema

#### Cliente Entity
- Primary fields: `id`, `nombre` (required), `correo`, `telefono`, `sexo`, `avatar`, `direccion`
- Serialization groups: `cliente:read`, `cliente:write`

#### Usuario Entity
- Implements Symfony's `UserInterface` and `PasswordAuthenticatedUserInterface`
- Fields: `id`, `nombreusuario`, `clave` (plain text), `avatar`, `nombre`, `correo`, `telefono`, `fechaNacimiento`
- User identifier: `nombreusuario`
- Default role: `ROLE_USER`
- Serialization groups: `usuario:read`, `usuario:write`

#### RefreshToken Entity
- Stores refresh tokens for JWT renewal
- Fields: `id`, `token`, `usuario` (relation), `expiresAt`
- Tokens expire after 30 days

#### Direccion Entity
- Appears to be a new entity (in untracked files)
- Repository: `DireccionRepository`

### Configuration Files

- **Database**: `.env` file contains `DATABASE_URL` (PostgreSQL connection)
- **JWT Keys**: Located in `config/jwt/` directory
  - `private.pem` - Private key for signing tokens
  - `public.pem` - Public key for verifying tokens
  - Passphrase stored in `.env` as `JWT_PASSPHRASE`
- **Security**: `config/packages/security.yaml` defines firewalls and access control
- **Doctrine**: `config/packages/doctrine.yaml` configures ORM settings

### Important Development Notes

1. **Entity Changes**: After modifying entities, always run `php bin/console make:migration` followed by `php bin/console doctrine:migrations:migrate`

2. **Serialization Groups**: Controllers use serialization groups to control JSON output. When adding fields to entities, include appropriate `#[Groups()]` attributes.

3. **ParamConverter**: Controllers use Symfony's automatic parameter conversion. For example, `Cliente $cliente` in route `/{id}` automatically fetches the entity.

4. **JSON Requests**: All POST/PATCH endpoints expect JSON payloads and use `json_decode($request->getContent())` to parse them.

5. **Error Handling**: Controllers return `JsonResponse` with appropriate HTTP status codes (200, 201, 400, 401, 404).

6. **Database Platform**: Configured for PostgreSQL with identity generation strategy.

## Environment Setup

1. Ensure PostgreSQL is running on `localhost:5432`
2. Database connection is configured in `.env` as `DATABASE_URL`
3. JWT keys must exist in `config/jwt/` (generate with `php bin/console lexik:jwt:generate-keypair`)
4. Run `composer install` to install dependencies
5. Execute `php bin/console doctrine:migrations:migrate` to set up database schema

## Common Workflows

### Adding a New Entity
```bash
# Generate entity
php bin/console make:entity NombreEntidad

# Create migration
php bin/console make:migration

# Run migration
php bin/console doctrine:migrations:migrate
```

### Creating a New API Endpoint
1. Create or modify controller in `src/Controller/`
2. Use `#[Route]` attributes to define endpoints
3. Add serialization groups to entity fields if needed
4. Test with `php bin/console debug:router`

### Updating an Existing Entity
1. Modify entity class in `src/Entity/`
2. Generate migration: `php bin/console make:migration`
3. Review generated migration in `migrations/`
4. Apply migration: `php bin/console doctrine:migrations:migrate`

## AWS Lambda Deployment

This backend can be deployed to AWS Lambda using Terraform. The infrastructure configuration is located in the `terraform/` directory.

### Deployment Architecture

```
[Frontend/BFF] → [API Gateway + API Key] → [Lambda (Symfony)] → [RDS PostgreSQL]
```

### Quick Start

```bash
# 1. Prepare backend
composer install
php bin/console lexik:jwt:generate-keypair

# 2. Configure Terraform
cd terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values

# 3. Deploy
terraform init
terraform apply

# 4. Get API Key
terraform output -raw api_key

# 5. Run migrations
aws lambda invoke --function-name crudmvvm-backend-console \
  --payload '{"cli": "doctrine:migrations:migrate --no-interaction"}' response.json
```

See `terraform/README.md` for detailed deployment instructions.

### API Gateway Protection

All API endpoints require an API Key sent as `X-API-Key` header:

```bash
curl -X POST https://your-api.execute-api.us-east-1.amazonaws.com/api/auth/login \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{"nombreUsuario": "admin", "clave": "password"}'
```
